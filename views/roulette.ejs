<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruleta - Amigo Secreto</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/roulette.css">
</head>

<body>
    <section>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 text-center">
                    <h1 class="display-4 fw-bold">🎁 ¡Gira la Ruleta y Descubre a tu <span class="fw-bold"
                            style="color: #357ABD;">Amigo Secreto</span>! 🎁</h1>
                    <p class="lead">Haz clic en el botón <span class="fw-bold" style="color: #357ABD;">"Girar
                            Ruleta"</span> para comenzar la emoción</p>
                </div>
            </div>
            <div class="row justify-content-center wheel-container" style="margin-top: -142px;">
                <div class="wheel shadow-lg bg-white" id="wheel">
                    <div class="wheel-strip" id="wheelStrip">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                        <img src="../studio.png" alt="Ruleta">
                    </div>
                </div>
            </div>
            <div class="row justify-content-center spin-btn">
                <div class="col-md-8 justify-content-center d-flex">
                    <button class="btn btn-lg fw-bold shadow" id="spinButton" style="margin-top: -55px;"> Girar
                        Ruleta</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal para mostrar el amigo secreto -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">Amigo Secreto Asignado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <h4 id="userName" class="mb-2"></h4>
                        <p id="userInfo" class="text-muted"></p>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h5 class="text-primary">Preferencias de Dulces:</h5>
                            <ul id="dulcesList" class="list-group">
                                <!-- Aquí se agregarán los dulces -->
                            </ul>
                            <div id="noDulces" class="text-center mt-2 text-muted" style="display: none;">No hay
                                preferencias de dulces.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h5 class="text-primary">Preferencias de Regalos:</h5>
                            <ul id="regalosList" class="list-group">
                                <!-- Aquí se agregarán los regalos -->
                            </ul>
                            <div id="noRegalos" class="text-center mt-2 text-muted" style="display: none;">No hay
                                preferencias de regalos.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            const spinButton = $('#spinButton');
            const wheelStrip = $('#wheelStrip');

            spinButton.on('click', () => {
                // Deshabilitar el botón mientras se ejecuta la animación
                spinButton.prop('disabled', true);

                fetch('/roulette/validate-dates', { method: 'POST' })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success === false) {
                            Swal.fire({
                                title: 'Ruleta Deshabilitada',
                                text: data.message,
                                icon: 'info',
                                confirmButtonText: 'Aceptar',
                                confirmButtonColor: '#357ABD'
                            });
                            spinButton.prop('disabled', false); // Volver a habilitar el botón si no se puede girar
                        } else {
                            fetch('/roulette/assign', { method: 'POST' })
                                .then((response) => response.json())
                                .then((data) => {
                                    if (data.success) {
                                        // Activar la animación de la ruleta
                                        wheelStrip.removeClass('scrolling');
                                        void wheelStrip.offsetWidth; // Forzar un reflujo para reiniciar la animación
                                        wheelStrip.addClass('scrolling');

                                        // Simular el tiempo de giro y luego mostrar el modal con información
                                        setTimeout(function () {
                                            $.ajax({
                                                url: '/roulette/amigo-preferencias',
                                                method: 'GET',
                                                success: function (response) {
                                                    if (response.success) {
                                                        const amigo = response.amigo;
                                                        if (amigo) {
                                                            $('#userName').text(`${amigo.nombre}`);
                                                            $('#userInfo').html(`Género: ${amigo.genero === 'F' ? 'Femenino' : 'Masculino'} - Área: ${amigo.area}`);

                                                            let regalos = amigo.regalos || [];
                                                            let dulces = amigo.dulces || [];

                                                            if (typeof regalos === 'string') {
                                                                regalos = regalos.split(',');
                                                            }

                                                            if (typeof dulces === 'string') {
                                                                dulces = dulces.split(',');
                                                            }

                                                            $('#regalosList').empty();
                                                            $('#dulcesList').empty();

                                                            if (regalos.length) {
                                                                regalos.forEach(function (regalo) {
                                                                    $('#regalosList').append(`<li class="list-group-item">${regalo}</li>`);
                                                                });
                                                                $('#noRegalos').hide();
                                                            } else {
                                                                $('#noRegalos').show();
                                                            }

                                                            if (dulces.length) {
                                                                dulces.forEach(function (dulce) {
                                                                    $('#dulcesList').append(`<li class="list-group-item">${dulce}</li>`);
                                                                });
                                                                $('#noDulces').hide();
                                                            } else {
                                                                $('#noDulces').show();
                                                            }

                                                            $('#resultModal').modal('show');

                                                            $('#resultModal').on('hidden.bs.modal', function () {
                                                                window.location.href = '/usuario-dashboard#amigo';
                                                            });
                                                        } else {
                                                            console.error('No se encontró información del amigo asignado.');
                                                        }
                                                    } else {
                                                        console.error('Error al obtener las preferencias del amigo.');
                                                    }
                                                    spinButton.prop('disabled', false); // Habilitar el botón después de la animación
                                                },
                                                error: function () {
                                                    console.error('Error en la solicitud para obtener las preferencias del amigo.');
                                                    spinButton.prop('disabled', false); // Habilitar el botón en caso de error
                                                }
                                            });
                                        }, 5000);
                                    } else {
                                        Swal.fire({
                                            title: data.status === 404 ? 'Sin asignar' : 'Error',
                                            text: data.message,
                                            icon: data.status === 404 ? 'info' : 'error',
                                            confirmButtonText: 'Aceptar',
                                            confirmButtonColor: '#357ABD'
                                        });
                                        spinButton.prop('disabled', false); // Habilitar el botón en caso de error
                                    }
                                })
                                .catch((error) => {
                                    Swal.fire({
                                        title: 'Error del servidor',
                                        text: 'Ocurrió un error inesperado. Inténtalo de nuevo más tarde.',
                                        icon: 'error',
                                        confirmButtonText: 'Aceptar',
                                    });
                                    console.error('Error:', error);
                                    spinButton.prop('disabled', false); // Habilitar el botón en caso de error
                                });
                        }
                    })
                    .catch((error) => {
                        Swal.fire({
                            title: 'Error del servidor',
                            text: 'Ocurrió un error inesperado. Inténtalo de nuevo más tarde.',
                            icon: 'error',
                            confirmButtonText: 'Aceptar',
                        });
                        console.error('Error:', error);
                        spinButton.prop('disabled', false); // Habilitar el botón en caso de error
                    });
            });
        });
    </script>
</body>

</html>