<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Amigo Secreto - Usuario</title>
    <link href="/css/styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.3/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>

<body id="page-top">
    <%- include('../partials/navbar'); %>
        <header class="position-relative">
            <video class="video-background" style="filter: brightness(60%);" autoplay muted loop>
                <source src="../donut.mp4" type="video/mp4">
                Su navegador no soporta la etiqueta de vídeo.
            </video>
            <div class="header-content text-center text-white">
                <h1 class="fw-bolder display-3">¡Bienvenido,
                    <span
                        style="color: #4A90E2; background-color: rgba(255, 255, 255, 0.7); padding: 0 10px; border-radius: 10px;">
                        <%= nombre %>
                    </span>!
                </h1>
                <p class="lead mb-4">Este es el juego de
                    <span class="fw-bold text-uppercase"
                        style="color: #FFD1E3; background-color: rgba(0, 0, 0, 0.5); padding: 0 10px; border-radius: 5px;">
                        AMIGO SECRETO
                    </span>.
                    Para comenzar, agrega tus dulces y regalos preferidos:
                </p>
                <a class="btn btn-lg rounded-pill" href="#deseos"
                    style="background-color: #2C3E50; color: #FFD1E3;">Agregar dulces y regalos</a>
            </div>
        </header>
        <!-- Deseos -->
        <section id="deseos" class="py-5" style="background-color: #D1E9F6;">
            <div class="container px-4">
                <div class="row gx-4 justify-content-center">
                    <div class="col-lg-10">
                        <h2 class="text-center pb-5 text-uppercase"
                            style="color: #4A90E2; font-size: 3rem; font-weight: bold;">🎁 Listas de Dulces y Regalos 🎁
                        </h2>
                        <p class="lead text-center" style="color: #2C3E50;  font-size: 1.3rem;">
                            Aquí puedes agregar los dulces y regalos que te gustaría recibir de tu <span
                                class="fw-bold text-uppercase" style="color: #2C3E50;  font-size: 1.3rem;">amigo
                                secreto</span>.
                        </p>
                        <div class="row pt-3">
                            <!-- Dulces -->
                            <div class="col-md-6 mb-4 deseos">
                                <div class="card shadow-sm border-0 h-100"
                                    style="background-color: #F3F9FC; border-radius: 20px;">
                                    <div class="card-body p-4 text-center">
                                        <img src="../dulce.gif" alt="Dulces" class="card-img-top mb-3 rounded-circle"
                                            style="width: 100px; height: 100px;">
                                        <h3 class="text-center mb-4" style="color: #4A90E2;">Lista de Dulces</h3>

                                        <!-- Botón para mostrar el input -->
                                        <button id="addDulce" class="btn text-light w-100 rounded-pill"
                                            style="background-color: #2C3E50;">Agregar Dulce</button>

                                        <!-- Contenedor del input y el nuevo botón -->
                                        <div id="dulceInputContainer" class="mt-3" style="display: none;">
                                            <div class="input-group">
                                                <input type="text" id="dulceInput" class="form-control rounded-pill"
                                                    placeholder="Escribe un dulce" style="border: 1px solid #4A90E2;">
                                                <button id="confirmAddDulce" class="btn text-light rounded-pill ms-2"
                                                    style="background-color: #4A90E2;">Añadir</button>
                                            </div>
                                        </div>

                                        <table id="dulceTable" class="table table-hover mt-3">
                                            <thead>
                                                <tr>
                                                    <th style="color: #4A90E2;">Dulces</th>
                                                    <th style="color: #4A90E2;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Aquí se agregarán los dulces -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!-- Regalos -->
                            <div class="col-md-6 mb-4 deseos">
                                <div class="card shadow-sm border-0 h-100"
                                    style="background-color: #F3F9FC; border-radius: 20px;">
                                    <div class="card-body p-4 text-center">
                                        <img src="../regalo.gif" alt="Regalos" class="card-img-top mb-3 rounded-circle"
                                            style="width: 100px; height: 100px;">
                                        <h3 class="text-center mb-4" style="color: #4A90E2;">Lista de Regalos</h3>
                                        <!-- Botón para mostrar el input -->
                                        <button id="addRegalo" class="btn text-light w-100 rounded-pill"
                                            style="background-color: #2C3E50;">Agregar Regalo</button>

                                        <!-- Contenedor del input y el nuevo botón -->
                                        <div id="regaloInputContainer" class="mt-3" style="display: none;">
                                            <div class="input-group">
                                                <input type="text" id="regaloInput" class="form-control rounded-pill"
                                                    placeholder="Escribe un regalo" style="border: 1px solid #4A90E2;">
                                                <button id="confirmAddRegalo" class="btn text-light rounded-pill ms-2"
                                                    style="background-color: #4A90E2;">Añadir</button>
                                            </div>
                                        </div>

                                        <table id="regaloTable" class="table table-hover mt-3">
                                            <thead>
                                                <tr>
                                                    <th style="color: #4A90E2;">Regalos</th>
                                                    <th style="color: #4A90E2;">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Aquí se agregarán los regalos -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <p class="lead text-center" style="color: #4A90E2; font-size: 1.8rem; font-weight: bold;">
                                Si ya agregaste tus dulces y regalos, ya puedes girar la ruleta, da clic en la flecha
                                para poder ir a girar la ruleta
                            </p>
                            <div class="text-center mt-3">
                                <a href="#roulette" style="text-decoration: none; color: #4A90E2;">
                                    <i class="fas fa-arrow-down" style="font-size: 2.5rem;"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="roulette">
            <%- include('./roulette'); %>
        </section>
        <!-- Amigo -->
        <section class="bg-light py-5" id="amigo" style="background-color: #D1E9F6;">
            <div class="container px-4">
                <div class="row gx-4 justify-content-center">
                    <div class="col-lg-10">
                        <h2 class="text-center pb-5 text-uppercase"
                            style="color: #4A90E2; font-size: 3rem; font-weight: bold;">
                            Información del Amigo Secreto
                        </h2>
                        <div class="card shadow-sm border-0" style="background-color: #F3F9FC; border-radius: 20px;">
                            <div class="card-body p-4">
                                <div class="row">
                                    <!-- Información básica del amigo -->
                                    <div class="col-12 mb-4">
                                        <div
                                            class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                                            <h4 class="text-wrap mb-2 mb-md-0">Nombre del Amigo: <span id="amigoNombre"
                                                    class="text-primary"></span></h4>
                                            <div class="d-flex flex-wrap">
                                                <span id="amigoGenero" class="badge text-wrap mb-2 mx-1"
                                                    style="background-color: #4A90E2; color: #ffffff;">Género</span>
                                                <span id="amigoArea" class="badge text-wrap mb-2"
                                                    style="background-color: #4A90E2; color: #ffffff;">Área</span>
                                                <span id="amigoCargo" class="badge text-wrap mx-1 mt-2"
                                                    style="background-color: #F1D3CE; color: #2C3E50;">Cargo</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Lista de regalos -->
                                    <div class="col-md-6 mb-4">
                                        <h5 class="text-uppercase" style="color: #4A90E2;">Regalos</h5>
                                        <ul id="amigoRegalos" class="list-group">
                                            <!-- Aquí se agregarán los regalos -->
                                        </ul>
                                        <!-- <div id="noRegalos" class="empty-message text-center mt-2"
                                            style="color: #2C3E50;">No hay regalos asignados.</div> -->
                                    </div>
                                    <!-- Lista de dulces -->
                                    <div class="col-md-6 mb-4">
                                        <h5 class="text-uppercase" style="color: #4A90E2;">Dulces</h5>
                                        <ul id="amigoDulces" class="list-group">
                                            <!-- Aquí se agregarán los dulces -->
                                        </ul>
                                        <!-- <div id="noDulces" class="empty-message text-center mt-2"
                                            style="color: #2C3E50;">No hay dulces asignados.</div> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer-->
        <%- include('../partials/footer'); %>

            <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
            <script
                src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
            <script src="https://cdn.datatables.net/2.1.3/js/dataTables.js"></script>
            <script src="https://cdn.datatables.net/2.1.3/js/dataTables.bootstrap5.js"></script>
            <script src="/js/scripts.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <script>
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        document.querySelector(this.getAttribute('href')).scrollIntoView({
                            behavior: 'smooth'
                        });
                    });
                });
            </script>
            <script>
                $(document).ready(function () {
                    // Inicializa DataTables
                    const dulceTable = $('#dulceTable').DataTable({
                        "language": {
                            "emptyTable": "No hay dulces añadidos aún."
                        },
                        info: false,
                        paging: false,
                        searching: false,
                        ordering: false,
                        columns: [
                            { title: "Dulces" },
                            { title: "", orderable: false, searchable: false }
                        ]
                    });

                    const regaloTable = $('#regaloTable').DataTable({
                        "language": {
                            "emptyTable": "No hay regalos añadidos aún."
                        },
                        info: false,
                        paging: false,
                        searching: false,
                        ordering: false,
                        columns: [
                            { title: "Regalos" },
                            { title: "", orderable: false, searchable: false }
                        ]
                    });

                    // Cargar los dulces desde el servidor
                    $.get('/preferences/dulces', function (response) {
                        if (response.success) {
                            response.dulces.forEach(dulce => {
                                dulceTable.row.add([
                                    dulce.dulce,
                                    `<button class="btn btn-danger btn-sm delete-dulce" data-id="${dulce.id_dulce}">Eliminar</button>`
                                ]).draw();
                            });
                        } else {
                            console.error('Error al cargar los dulces:', response.message);
                        }
                    });

                    // Cargar los regalos desde el servidor
                    $.get('/preferences/regalos', function (response) {
                        if (response.success) {
                            response.regalos.forEach(regalo => {
                                regaloTable.row.add([
                                    regalo.regalo,
                                    `<button class="btn btn-danger btn-sm delete-regalo" data-id="${regalo.id_regalo}">Eliminar</button>`
                                ]).draw();
                            });
                        } else {
                            console.error('Error al cargar los regalos:', response.message);
                        }
                    });

                    // Mostrar el contenedor con el input y el botón cuando se haga clic en "Agregar Dulce"
                    $('#addDulce').click(function () {
                        $('#dulceInputContainer').slideDown(); // Muestra el contenedor con animación
                        $('#dulceInput').focus(); // Coloca el foco en el input
                    });

                    // Función para añadir el dulce
                    $('#confirmAddDulce').click(function () {
                        const dulce = $('#dulceInput').val().trim();
                        if (dulce) {
                            $.post('/preferences/dulces', { dulce: dulce }, function (response) {
                                if (response.success) {
                                    // Añade el dulce directamente a DataTables
                                    dulceTable.row.add([
                                        dulce,
                                        `<button class="btn btn-danger btn-sm delete-dulce" data-id="${response.id}">Eliminar</button>`
                                    ]).draw(); // Notifica a DataTables para actualizar la vista

                                    $('#dulceInput').val(''); // Limpia el input
                                    $('#dulceInputContainer').slideUp(); // Oculta el contenedor
                                    Swal.fire({
                                        title: '¡Éxito!',
                                        text: 'Dulce agregado correctamente.',
                                        icon: 'success',
                                        confirmButtonText: 'Aceptar',
                                        confirmButtonColor: '#4A90E2'
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Error',
                                        text: response.message,
                                        icon: 'error',
                                        confirmButtonText: 'Aceptar',
                                        confirmButtonColor: '#E74C3C'
                                    });
                                }
                            });
                        } else {
                            Swal.fire({
                                title: 'Advertencia',
                                text: 'Por favor escriba un dulce.',
                                icon: 'warning',
                                confirmButtonText: 'Aceptar',
                                confirmButtonColor: '#F1C40F',
                            });
                        }
                    });


                    // Mostrar el contenedor con el input y el botón cuando se haga clic en "Agregar Regalo"
                    $('#addRegalo').click(function () {
                        $('#regaloInputContainer').slideDown(); // Muestra el contenedor con animación
                        $('#regaloInput').focus(); // Coloca el foco en el input
                    });

                    // Función para añadir un regalo
                    $('#confirmAddRegalo').click(function () {
                        const regalo = $('#regaloInput').val().trim();
                        if (regalo) {
                            $.post('/preferences/regalos', { regalo: regalo }, function (response) {
                                if (response.success) {
                                    // Añade el regalo directamente a DataTables
                                    regaloTable.row.add([
                                        regalo,
                                        `<button class="btn btn-danger btn-sm delete-regalo" data-id="${response.id}">Eliminar</button>`
                                    ]).draw(); // Notifica a DataTables para actualizar la vista

                                    $('#regaloInput').val(''); // Limpia el input
                                    $('#regaloInputContainer').slideUp(); // Oculta el contenedor
                                    Swal.fire({
                                        title: '¡Éxito!',
                                        text: 'Regalo agregado correctamente.',
                                        icon: 'success',
                                        confirmButtonText: 'Aceptar',
                                        confirmButtonColor: '#4A90E2'
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Error',
                                        text: response.message,
                                        icon: 'error',
                                        confirmButtonText: 'Aceptar',
                                        confirmButtonColor: '#E74C3C'
                                    });
                                }
                            });
                        } else {
                            Swal.fire({
                                title: 'Advertencia',
                                text: 'Por favor escriba un regalo.',
                                icon: 'warning',
                                confirmButtonText: 'Aceptar',
                                confirmButtonColor: '#F1C40F',
                            });
                        }
                    });

                    // Función para eliminar dulce
                    $('#dulceTable tbody').on('click', '.delete-dulce', function () {
                        const button = $(this);
                        const dulceId = $(this).data('id');;

                        Swal.fire({
                            title: '¿Estás seguro?',
                            text: 'No podrás revertir esto.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#4A90E2',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Sí, eliminarlo'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $.ajax({
                                    url: `/preferences/dulces/${dulceId}`,
                                    type: 'DELETE',
                                    success: function (response) {
                                        if (response.success) {
                                            dulceTable.row(button.parents('tr')).remove().draw();
                                            Swal.fire({
                                                title: 'Eliminado',
                                                text: 'El dulce ha sido eliminado.',
                                                icon: 'success',
                                                confirmButtonText: 'Aceptar',
                                                confirmButtonColor: '#4A90E2'
                                            });
                                        } else {
                                            Swal.fire('Error', 'Error al eliminar el dulce.', 'error');
                                        }
                                    },
                                    error: function () {
                                        Swal.fire('Error', 'Error en la solicitud.', 'error');
                                    }
                                });
                            }
                        });
                    });

                    // Función para eliminar regalo
                    $('#regaloTable tbody').on('click', '.delete-regalo', function () {
                        const button = $(this);
                        const regaloId = $(this).data('id');;

                        Swal.fire({
                            title: '¿Estás seguro?',
                            text: 'No podrás revertir esto.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Sí, eliminarlo'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $.ajax({
                                    url: `/preferences/regalos/${regaloId}`,
                                    type: 'DELETE',
                                    success: function (response) {
                                        if (response.success) {
                                            regaloTable.row(button.parents('tr')).remove().draw();
                                            Swal.fire({
                                                title: 'Eliminado',
                                                text: 'El dulce ha sido eliminado.',
                                                icon: 'success',
                                                confirmButtonText: 'Aceptar',
                                                confirmButtonColor: '#4A90E2'
                                            });
                                        } else {
                                            Swal.fire('Error', 'Error al eliminar el regalo.', 'error');
                                        }
                                    },
                                    error: function () {
                                        Swal.fire('Error', 'Error en la solicitud.', 'error');
                                    }
                                });
                            }
                        });
                    });
                });
            </script>
            <script>
                $(document).ready(function () {
                    fetch('/roulette/amigo-preferencias')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.amigo) {
                                const amigo = data.amigo;

                                // Actualiza el nombre del amigo
                                $('#amigoNombre').text(`${amigo.nombre}`);

                                // Muestra o esconde los badges según los datos
                                $('#amigoGenero').text(`Género: ${amigo.genero === 'F' ? 'Femenino' : 'Masculino'}`).toggle(!!amigo.genero);
                                $('#amigoArea').text(`Área: ${amigo.area}`).toggle(!!amigo.area);
                                $('#amigoCargo').text(`Cargo: ${amigo.cargo}`).toggle(!!amigo.cargo);

                                // Actualiza la lista de regalos
                                const regalos = amigo.regalos || [];
                                $('#amigoRegalos').empty(); // Limpia la lista para evitar duplicados
                                if (regalos.length > 0) {
                                    regalos.forEach(regalo => {
                                        $('#amigoRegalos').append(`<li class="list-group-item">${regalo}</li>`);
                                    });
                                    $('#noRegalos').hide();
                                } else {
                                    $('#noRegalos').show();
                                }

                                // Actualiza la lista de dulces
                                const dulces = amigo.dulces || [];
                                $('#amigoDulces').empty(); // Limpia la lista para evitar duplicados
                                if (dulces.length > 0) {
                                    dulces.forEach(dulce => {
                                        $('#amigoDulces').append(`<li class="list-group-item">${dulce}</li>`);
                                    });
                                    $('#noDulces').hide();
                                } else {
                                    $('#noDulces').show();
                                }
                            } else {
                                // Oculta los badges si no hay datos
                                $('#amigoGenero').hide();
                                $('#amigoArea').hide();
                                $('#amigoCargo').hide();
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar la información del amigo:', error);
                            // Oculta los badges si hay un error
                            $('#amigoGenero').hide();
                            $('#amigoArea').hide();
                            $('#amigoCargo').hide();
                        });
                });
            </script>
</body>

</html>